<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          rel="stylesheet"
  />
  <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />

  <style>
    /* Sidebar styling */
    .sidebar {
      min-height: 100vh;
      position: fixed;
      width: 16.66%;
      background-color: #343a40;
    }
    .sidebar .nav-link {
      color: #fff;
    }
    .sidebar .nav-link.active-border {
      border-left: 4px solid #17a7be;
      background-color: #495057;
      color: #ffffff;
    }
    .styleUser {
      margin-top: 20%;
      color: #fff;
    }
    .styleForm {
      width: 50%;
      margin: 0 auto;
    }
    .main-content {
      margin-left: 16.66%;
      padding-top: 20px;
    }
    .dashboard-card {
      color: white;
      font-weight: bold;
    }
    .bg-blue {
      background-color: #17a2b8;
    }
    .bg-green {
      background-color: #28a745;
    }
    .bg-orange {
      background-color: #fd7e14;
    }
    .bg-red {
      background-color: #dc3545;
    }
    .card .icon {
      font-size: 40px;
      opacity: 0.3;
      position: absolute;
      top: 10px;
      right: 10px;
    }
    .section-title {
      font-weight: bold;
      margin-top: 20px;
    }
    .chart_1{
      width: 350px !important;
      height: 350px !important;
    }
    .table {
      background-color: #f9f9f9;
    }

    .table th, .table td {
      text-align: center;
    }
    .table img {
      border-radius: 5px;
    }
    .dashboard-card {
      border-radius: 10px;
      color: white;
      padding: 20px;
      position: relative;
    }
    .bg-processing {
      background-color: #ffc107;
    }
    .bg-shipped {
      background-color: #17a2b8;
    }
    .bg-delivered {
      background-color: #28a745;
    }
    .bg-return {
      background-color: #dc3545;
    }
    .card .icon {
      font-size: 30px;
      opacity: 0.7;
    }
    .section-title {
      font-size: 14px;
      margin-top: 15px;
      font-weight: bold;
    }
    a.text-white {
      font-size: 12px;
      text-decoration: none;
    }
    .card h4, .card h5, .card p {
      margin: 0;
    }

  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="sidebar col-md-2 d-none d-md-block">
      <div class="sidebar-sticky">
        <h4 class="text-light text-center mt-4">AdminAD</h4>
        <ul class="nav flex-column mt-3">
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="http://localhost:3000/orders/Home" onclick="setActive(this)">Home</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Thành viên</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Bài viết</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Danh mục</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Sản phẩm</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="http://localhost:3000/orders/view" onclick="setActive(this)">Đơn hàng</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Quản lý kho</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="#" onclick="setActive(this)">Danh sách liên hệ</a>
          </li>
          <li class="nav-item mt-3">
            <a class="nav-link text-light" href="http://localhost:3000/vouchers/view" onclick="setActive(this)">Khuyến Mãi</a>
          </li>
        </ul>
        <div class="styleUser text-center " >
          <h6>Hồ Đức Trí Hiếu</h6>
          <button class="btn btn-danger stylebtnDangXuat">Đăng Xuất</button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content col-md-10">
      <h2 class="mb-4">Quản Trị Website</h2>
      <div class="row">
        <!-- Loop qua từng trạng thái và hiển thị thành card -->
        <div class="col-md-3 mb-4" th:each="entry : ${statistics}">
          <div
                  class="card dashboard-card position-relative"
                  th:classappend="${entry.key} == 'Processing' ? 'bg-processing' :
                        (${entry.key} == 'Shipped' ? 'bg-shipped' :
                        (${entry.key} == 'Delivered' ? 'bg-delivered' :
                        'bg-return'))">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h4 th:text="${entry.value}">0</h4>
                  <p th:text="${entry.key}">Status</p>
                </div>
                <i th:class="'fas icon ' +
              (${entry.key} == 'Processing' ? 'fa-spinner' :
              (${entry.key} == 'Shipped' ? 'fa-truck' :
              (${entry.key} == 'Delivered' ? 'fa-check-circle' :
              'fa-undo-alt')))">
                </i>
              </div>

            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <!-- Đơn hàng -->
        <div class="col-md-3 mb-4">
          <div class="card dashboard-card bg-blue position-relative">
            <div class="card-body">
              <div
                      class="d-flex justify-content-between align-items-center"
              >
                <div>
                  <h4 th:text="${totalOrders}"></h4>
                  <p>Đơn hàng</p>
                </div>
                <i class="fas fa-shopping-bag icon"></i>
              </div>
              <div class="section-title">DOANH THU HÔM NAY</div>
              <h4><span th:text="${totalRevenue}"></span><span> VND</span></h4>
              <a href="#" class="text-white"
              >More info <i class="fas fa-arrow-circle-right"></i
              ></a>
            </div>
          </div>
        </div>

        <!-- Sản phẩm -->
        <div class="col-md-3 mb-4">
          <div class="card dashboard-card bg-red position-relative">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h4 th:text="${totalOrdersYear}"></h4>
                  <p>Sản Phẩm</p>
                </div>
                <i class="fas fa-chart-pie icon"></i>
              </div>
              <div class="section-title">DOANH THU NĂM</div>
              <h5><span th:text="${totalRevenueYear}"></span><span> VND</span></h5>
              <a href="#" class="text-white"
              >More info <i class="fas fa-arrow-circle-right"></i
              ></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="main-content col-md-10">
      <h2>Thống Kê Đoanh Thu Dựa Trên Số Đơn Hàng</h2>
      <form id="revenueForm" class="mb-4">
        <div class="row">
          <div class="col-md-7 mb-3">
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-group">
                  <label for="startDate" class="form-label">Ngày bắt đầu:</label>
                  <input type="date" id="startDate" name="startDate" th:value="${startDate}" required class="form-control">
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-group">
                  <label for="endDate" class="form-label">Ngày kết thúc:</label>
                  <input type="date" id="endDate" name="endDate" th:value="${endDate}" required class="form-control">
                </div>
              </div>
              <div class="col-md-12 mb-3">
                <button type="submit" class="btn btn-primary w-100">Thống Kê</button>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <p>Tổng doanh thu: <span id="totalRevenue" th:text="${totalRevenue}">...</span> VNĐ</p>
                <p>Tổng số đơn hàng: <span id="totalOrders" th:text="${totalOrders}">...</span></p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <canvas id="revenueChart" class="chart_1"></canvas>
          </div>
        </div>
      </form>
    </div>
    <div class="main-content col-md-10">
          <h2>Best selling products</h2>

          <div class="mb-4">
            <label for="timeType" class="form-label">Chọn loại thời gian:</label>
            <select id="timeType" class="form-control w-auto">
              <option value="day">Ngày</option>
              <option value="week">Tuần</option>
              <option value="month">Tháng</option>
              <option value="year">Năm</option>
            </select>
          </div>
          <table class="table table-striped table-bordered">
            <thead>
            <tr>
              <th>Tên Sản Phẩm</th>
              <th>Thương Hiệu</th>
              <th>Danh Mục</th>
            </tr>
            </thead>
            <tbody id="productsTableBody">
            </tbody>
          </table>
          <div class="pagination-wrapper text-center">
            <button id="prevPage" class="btn btn-primary" disabled>Previous</button>
            <button id="nextPage" class="btn btn-primary">Next</button>
          </div>

    </div>

    <div class="main-content col-md-10">
      <h2 class="text-center">Top Loyal Customers</h2>
      <div class="table-container" style="display: flex; justify-content: center; align-items: center; height: 100%;">
        <table border="1" class="table table-striped table-bordered" style="width: 100%; max-width: 800px;">
          <thead>
          <tr>
            <th>Name</th>
            <th>UserName</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Order Count</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="customer : ${loyalCustomer}">
            <td th:text="${customer['name']}"></td>
            <td th:text="${customer['userName']}"></td>
            <td th:text="${customer['email']}"></td>
            <td th:text="${customer['phone']}"></td>
            <td th:text="${customer['orderCount']}"></td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var totalRevenue = document.getElementById("totalRevenue").textContent;
    var totalOrders = document.getElementById("totalOrders").textContent;

    var revenueChart;
    function drawChart(totalRevenue, totalOrders) {
      var ctx = document.getElementById('revenueChart').getContext('2d');
      if (revenueChart) {
        revenueChart.destroy();
      }
      revenueChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Doanh thu', 'Số đơn hàng'],
          datasets: [{
            label: 'Thông tin thống kê',
            data: [totalRevenue, totalOrders],
            backgroundColor: ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)'],
            borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
        }
      });
    }
    drawChart(totalRevenue, totalOrders);
    $('#revenueForm').submit(function(event) {
      event.preventDefault();

      var startDate = $('#startDate').val();
      var endDate = $('#endDate').val();

      $.ajax({
        url: '/orders/thong-ke',
        method: 'GET',
        data: {
          startDate: startDate,
          endDate: endDate
        },
        success: function(response) {
          console.log(response);
          var totalRevenue = response.totalRevenue;
          var totalOrders = response.totalOrders;
          document.getElementById("totalRevenue").textContent = totalRevenue;
          document.getElementById("totalOrders").textContent = totalOrders;
          drawChart(totalRevenue, totalOrders);
        },
        error: function(xhr, status, error) {
          alert("Có lỗi xảy ra khi tải dữ liệu.");
        }
      });
    });
  });
  let currentPage = 0;
  const size = 5;
  function loadTopSellingProducts() {
    const timeType = document.getElementById('timeType').value;
    $.ajax({
      url: '/orders/top-selling',
      method: 'GET',
      data: {
        type: timeType,
        page: currentPage,
        size: size
      },
      success: function(response) {
        const products = response.products;
        console.log("Products received:", products);
        const tableBody = document.getElementById('productsTableBody');
        tableBody.innerHTML = '';  // Xóa bảng cũ

        // Lặp qua danh sách sản phẩm và thêm vào bảng
        products.forEach(function(product) {
          const row = document.createElement('tr');
          row.innerHTML = `
                    <td>${product.productName}</td>
                    <td>${product.brand.name}</td>
                    <td>${product.category.name}</td>
                `;
          tableBody.appendChild(row);
        });

        // Cập nhật trạng thái của các nút phân trang
        document.getElementById('prevPage').disabled = currentPage <= 0;
        document.getElementById('nextPage').disabled = products.length < size;  // Nếu ít hơn số lượng trang, vô hiệu nút next
      },
      error: function(xhr, status, error) {
        alert("Có lỗi xảy ra khi tải dữ liệu.");
      }
    });
  }

  // Sự kiện thay đổi loại thời gian
  document.getElementById('timeType').addEventListener('change', function() {
    currentPage = 0;  // Quay lại trang đầu khi thay đổi loại thời gian
    loadTopSellingProducts();
  });

  // Sự kiện nút Previous
  document.getElementById('prevPage').addEventListener('click', function() {
    if (currentPage > 0) {
      currentPage--;
      loadTopSellingProducts();
    }
  });

  // Sự kiện nút Next
  document.getElementById('nextPage').addEventListener('click', function() {
    currentPage++;
    loadTopSellingProducts();
  });

  // Tải dữ liệu sản phẩm bán chạy lần đầu
  loadTopSellingProducts();


</script>
</body>
</html>
