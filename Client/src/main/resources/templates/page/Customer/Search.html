<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tìm kiếm</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/Search.css">
</head>

<body class="page-search">
<div id="header"></div>
<div class="container my-5" id="product-search">
    <div class="filter-header">
        <a href="#">Ẩn Bộ Lọc <i class="fas fa-sliders-h"></i></a>
        <div class="dropdown">
            <a href="#" class="dropdown-toggle" id="sortByDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Sắp Xếp</a>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="sortByDropdown">
                <a class="dropdown-item" href="#">Nổi bật</a>
                <a class="dropdown-item" href="#">Mới nhất</a>
                <a class="dropdown-item" href="#">Giá: Cao - Thấp</a>
                <a class="dropdown-item" href="#">Giá: Thấp - Cao</a>
            </div>
        </div>
    </div>

    <form id="filter-form" action="/product-search/filtered" method="GET">
        <div class="row" >
            <div class="col-md-3">
                <!-- Bộ lọc theo loại sản phẩm -->
                <div class="filter-section">
                    <h5>Loại sản phẩm</h5>
                    <ul class="list-unstyled">
                        <li class="filter-option" th:each="category : ${categories}">
                            <label>
                                <input type="checkbox" name="categoryIds" th:value="${category.categoryID}" class="filter-input"/>
                                <span th:text="${category.name}"></span>
                                <span th:text="'(' + ${category.productCount} + ')'"></span>
                            </label>
<!--                            <label>-->
<!--                                <input type="checkbox" name="category" value="1" class="filter-input"/>-->
<!--                                <span th:text="1"></span>-->

<!--                            </label>-->
                        </li>
                    </ul>
                </div>

                <!-- Bộ lọc theo giá -->
                <div class="filter-section">
                    <h5>Giá</h5>
                    <div class="price-grid">
                        <label><input type="radio" class="filter-input" name="price" value="under50" /> Dưới 50</label>
                        <label><input type="radio" class="filter-input" name="price" value="50-100" /> 50 đến 100</label>
                        <label><input type="radio" class="filter-input" name="price" value="100-150" /> 100 đến 150</label>
                        <label><input type="radio" class="filter-input" name="price" value="150-200" /> 150 đến 200</label>
                        <label><input type="radio" class="filter-input" name="price" value="200-300" /> 200 đến 300</label>
                        <label><input type="radio" class="filter-input" name="price" value="over300" /> Trên 300</label>
                    </div>
                </div>

                <!-- Bộ lọc theo thương hiệu -->
                <div class="filter-section">
                    <h5>Thương hiệu</h5>
                    <ul class="list-unstyled">
                        <li class="filter-option" th:each="brands : ${brands}">
                            <label>
                                <input type="checkbox" name="brandIds" th:value="${brands.brandID}" class="filter-input" />
                                <span th:text="${brands.name}"></span>
                            </label>
                        </li>
                    </ul>
                </div>

                <!-- Bộ lọc theo màu sắc -->
                <div class="filter-section">
                    <h5>Màu sắc</h5>
                    <div class="color-options">
                        <span class="color-circle"
                              th:each="color : ${colors}"
                              th:style="'background-color:' + ${color.colorName}"
                              th:data-color-name="${color.colorName}"
                              onclick="selectColor(this)"></span>
                    </div>
                </div>

<!--                <input type="hidden" name="colors" id="selected-color">-->

                <!-- Bộ lọc theo kích cỡ -->
                <div class="filter-section">
                    <h5>Kích cỡ</h5>
                    <div class="size-options">
                        <div class="size-option" th:each="size : ${sizes}" th:text="${size}"></div>
                    </div>
                </div>
            </div>

            <!-- Lưới sản phẩm -->
            <div class="col-md-9">
                <div class="row" id="products-container">
                    <th:block th:each="product : ${products}">
                        <div class="col-md-4 mb-4">
                            <a th:href="@{'/product-details/' + ${product.productID}}" class="link-details">
                                <div class="product-card">
                                    <img th:src="@{${product.imageURL.get(0)}}"/>
                                    <div class="product-info">
                                        <h6 th:text="${product.productName}"></h6>
                                        <p th:text="${product.description}"></p>
                                        <p class="product-price" th:text="${product.price}"></p>
                                    </div>

                                    <div class="add-to-cart">
                                        <i class="fas fa-shopping-cart"></i>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </th:block>
                </div>

                <!-- Phân trang -->
                <div class="pagination-container">
                    <ul class="pagination">
                        <li class="page-item"><a class="page-link" href="#">Trước</a></li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item active"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item"><a class="page-link" href="#">Tiếp</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </form>
</div>
<div id="footer"></div>

<script src="/js/Home.js"></script>
<script src="/js/script.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function updateFilterState() {
        const urlParams = new URLSearchParams(window.location.search);

        // Cập nhật các checkbox và radio buttons từ URL query string
        document.querySelectorAll('.filter-input').forEach(input => {
            const name = input.name;
            if (urlParams.has(name)) {
                if (input.type === 'checkbox') {
                    // Nếu là checkbox, kiểm tra xem giá trị có trong queryString không
                    const values = urlParams.getAll(name);
                    input.checked = values.includes(input.value);
                } else if (input.type === 'radio') {
                    // Nếu là radio, kiểm tra xem giá trị có trong queryString không
                    input.checked = input.value === urlParams.get(name);
                }
            }
        });
    }


    document.addEventListener("DOMContentLoaded", function () {
        function submitForm() {
            const form = document.getElementById('filter-form');
            const formData = new FormData(form);

            // Tạo chuỗi query từ formData
            let queryString = new URLSearchParams(formData).toString();

            // Cập nhật URL mà không tải lại trang
            history.pushState(null, "", "?" + queryString);

            // Gửi dữ liệu đến server mà không tải lại trang
            fetch(form.action + "?" + queryString, {
                method: 'GET',
            })
                .then(response => response.text())
                .then(data => {
                    console.log(data);
                    // Cập nhật lại danh sách sản phẩm mà không làm tải lại trang
                    document.getElementById('products-container').innerHTML = data;
                    // Cập nhật lại trạng thái của bộ lọc sau khi dữ liệu trả về
                    updateFilterState();
                })
                .catch(error => console.error('Error:', error));
        }

        // Bắt sự kiện thay đổi bộ lọc
        const filterInputs = document.querySelectorAll('.filter-input');
        filterInputs.forEach(input => {
            input.addEventListener('change', function () {
                submitForm();  // Gửi form khi có thay đổi
            });
        });

        // Cập nhật trạng thái ban đầu của bộ lọc từ URL
        updateFilterState();
    });








</script>
</body>
</html>
